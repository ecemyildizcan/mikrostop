<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mikrop Avcƒ±larƒ±: Puzzle G√∂revi</title>
    <!-- Baloo 2 fontu y√ºklendi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Baloo 2', cursive;
            background-color: #0f172a;
            color: #f8fafc;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .font-baloo-bold { font-family: 'Baloo 2', cursive; font-weight: 800; }
        
        .game-card {
            background: rgba(30, 41, 59, 1);
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 2.5rem;
            width: 95%;
            max-width: 800px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        }

        /* Puzzle G√∂r√ºn√ºm√º */
        #puzzle-view {
            position: absolute;
            inset: 0;
            z-index: 50;
            background: #1e293b;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 2px;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(100%);
            pointer-events: none;
        }

        #puzzle-view.active {
            transform: translateY(0);
            pointer-events: auto;
        }

        #puzzle-ghost {
            position: absolute;
            inset: 0;
            background-image: url('https://raw.githubusercontent.com/ecemyildizcan/mikrostop/main/asserts/start.JPEG');
            background-size: cover;
            background-position: center;
            opacity: 0.2;
            z-index: 0;
        }

        .puzzle-slot {
            position: relative;
            z-index: 1;
            border: 2px dashed rgba(255, 255, 255, 0.1);
            overflow: hidden;
            background: rgba(0,0,0,0.3);
            cursor: default;
            transition: all 0.3s;
        }

        .puzzle-slot.clickable {
            cursor: pointer;
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            animation: pulse-border 1.5s infinite;
        }

        @keyframes pulse-border {
            0% { border-color: rgba(59, 130, 246, 0.3); }
            50% { border-color: rgba(59, 130, 246, 1); }
            100% { border-color: rgba(59, 130, 246, 0.3); }
        }

        .puzzle-piece {
            position: absolute;
            inset: 0;
            background-image: url('https://raw.githubusercontent.com/ecemyildizcan/mikrostop/main/asserts/end.JPEG');
            background-size: 300% 200%;
            opacity: 0;
            transform: scale(2) rotate(30deg);
            transition: all 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .puzzle-piece.placed {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        /* Yeni Daƒüƒ±nƒ±k √áamur Efekti Stilleri */
        .mud-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 150;
        }

        .mud-splat {
            position: absolute;
            background: #4a3427; /* √áamur rengi */
            opacity: 0;
            animation: mudSplatAnimation 3s ease-out forwards;
            box-shadow: inset 5px 5px 15px rgba(0,0,0,0.4);
            filter: blur(1px);
        }

        @keyframes mudSplatAnimation {
            0% { transform: scale(0.2) rotate(0deg); opacity: 0; }
            10% { transform: scale(1.1) rotate(15deg); opacity: 0.9; }
            20% { transform: scale(1) rotate(10deg); opacity: 1; }
            80% { transform: scale(1) translateY(10px); opacity: 1; }
            100% { transform: scale(0.8) translateY(100vh); opacity: 0; }
        }

        /* Soru Alanƒ± */
        #question-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 2rem;
            z-index: 10;
        }

        .btn-game {
            transition: all 0.2s;
            border-bottom: 4px solid rgba(0,0,0,0.4);
            cursor: pointer;
            pointer-events: auto;
            font-weight: 700;
        }
        .btn-game:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        .btn-game:active {
            transform: translateY(2px);
            border-bottom-width: 1px;
        }

        .shake { animation: shake 0.5s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        #feedback-overlay {
            position: absolute;
            inset: 0;
            z-index: 100;
            background: rgba(15, 23, 42, 0.98);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
        }

        /* Ba≈ülangƒ±√ß Ekranƒ± */
        #start-screen {
            position: absolute;
            inset: 0;
            z-index: 200;
            background: #0f172a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            pointer-events: auto;
            overflow: hidden;
        }

        .hero-img-feedback {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 8px solid #3b82f6;
            margin-bottom: 1.5rem;
            object-fit: cover;
            background: white;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
        }

        /* Animasyonlar */
        .bounce-mikrop {
            animation: mini-bounce-right 2s infinite ease-in-out;
        }

        .bounce-kahraman {
            animation: mini-bounce-left 2s infinite ease-in-out;
            animation-delay: 0.5s;
        }

        .hero-breathing {
            animation: breathing 3s infinite ease-in-out;
            transform-origin: bottom left;
        }

        @keyframes breathing {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        @keyframes mini-bounce-right {
            0%, 100% { transform: translateY(0) rotate(5deg); }
            50% { transform: translateY(-25px) rotate(-5deg); }
        }

        @keyframes mini-bounce-left {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-25px) rotate(5deg); }
        }

        .side-character {
            transition: transform 0.3s ease;
        }
        .side-character:hover {
            transform: scale(1.15) !important;
        }
    </style>
</head>
<body>

    <div id="mud-container" class="mud-container"></div>

    <div class="game-card" id="main-card">
        <!-- Ba≈ülangƒ±√ß -->
        <div id="start-screen">
            <!-- Karakterler -->
            <img src="https://raw.githubusercontent.com/ecemyildizcan/mikrostop/main/asserts/kahraman.png" 
                 class="absolute -left-10 bottom-10 w-64 md:w-80 side-character hero-breathing z-10" alt="Kahraman">
            
            <img src="https://raw.githubusercontent.com/ecemyildizcan/mikrostop/main/asserts/mikrop.png" 
                 class="absolute -right-10 bottom-10 w-64 md:w-80 side-character z-10 animate-pulse" alt="Mikrop">

            <div class="z-20 flex flex-col items-center">
                <div class="relative mb-2">
                    <!-- Sol tarafa zƒ±playan Kahraman -->
                    <img src="https://raw.githubusercontent.com/ecemyildizcan/mikrostop/main/asserts/kahraman.png" 
                         class="absolute -top-16 -left-16 w-24 h-24 bounce-kahraman" alt="Zƒ±playan Kahraman">
                    
                    <h1 class="text-6xl md:text-8xl font-baloo-bold text-white drop-shadow-[0_10px_10px_rgba(0,0,0,0.5)] leading-none uppercase">Mƒ∞KROSTOP</h1>
                    
                    <!-- Saƒü tarafa zƒ±playan Mikrop -->
                    <img src="https://raw.githubusercontent.com/ecemyildizcan/mikrostop/main/asserts/mikrop.png" 
                         class="absolute -top-16 -right-16 w-24 h-24 bounce-mikrop" alt="Zƒ±playan Mikrop">
                </div>
                
                <h2 class="text-3xl md:text-4xl font-baloo-bold text-blue-500 mb-12 tracking-widest drop-shadow-md uppercase">Mƒ∞KROP AVCILARI</h2>
                
                <button onclick="startGame()" class="btn-game bg-blue-600 px-20 py-8 rounded-full text-4xl text-white shadow-[0_10px_0_rgb(29,78,216)] active:shadow-none mb-6">
                    BA≈ûLA
                </button>
                <p class="text-slate-200 text-lg font-bold bg-black/40 px-6 py-2 rounded-full backdrop-blur-sm">Odayƒ± temizlemek i√ßin doƒüru cevaplarƒ± ver!</p>
            </div>
        </div>

        <!-- HUD -->
        <div id="hud" class="hidden bg-slate-800 p-4 flex justify-between items-center px-8 border-b border-white/10 relative z-30">
            <div class="flex flex-col">
                <span class="text-slate-400 text-[11px] font-bold uppercase tracking-wider">Puzzle Durumu</span>
                <div class="w-32 h-3 bg-slate-900 rounded-full mt-1 overflow-hidden">
                    <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-700" style="width: 0%"></div>
                </div>
            </div>
            <div id="badge-display" class="text-2xl"></div>
            <div class="text-right">
                <span class="text-slate-400 text-[11px] font-bold uppercase tracking-wider">ƒ∞lerleme</span>
                <div id="score-display" class="text-2xl font-bold text-yellow-400">0</div>
            </div>
        </div>

        <!-- Soru Ekranƒ± -->
        <div id="question-view" class="hidden">
            <div class="space-y-8">
                <div class="text-center">
                    <span id="question-category" class="bg-blue-600 text-white px-6 py-2 rounded-full text-sm font-bold uppercase tracking-widest">KATEGORƒ∞</span>
                </div>
                <h2 id="question-text" class="text-3xl md:text-4xl font-bold text-center px-4 text-white leading-tight">Soru Y√ºkleniyor...</h2>
                <div id="options-container" class="grid grid-cols-1 gap-4 max-w-md mx-auto w-full"></div>
            </div>
        </div>

        <!-- Puzzle G√∂r√ºn√ºm√º -->
        <div id="puzzle-view">
            <div id="puzzle-ghost"></div>
        </div>

        <!-- Feedback Overlay -->
        <div id="feedback-overlay">
            <div id="feedback-hero-container">
                <img src="https://raw.githubusercontent.com/ecemyildizcan/mikrostop/main/asserts/kahraman.png" class="hero-img-feedback" alt="Kahraman">
            </div>
            <div id="feedback-text" class="text-5xl font-bold mb-2"></div>
            <div id="feedback-sub" class="text-slate-300 text-2xl font-bold max-w-md"></div>
        </div>

        <!-- Final -->
        <div id="result-screen" class="hidden absolute inset-0 z-[300] bg-slate-900 flex flex-col items-center justify-center p-8 text-center">
            <h2 class="text-7xl font-bold text-yellow-400 mb-6 uppercase">TEBRƒ∞KLER!</h2>
            <div class="text-9xl mb-8">üèÜ</div>
            <div id="final-stats" class="text-3xl text-white mb-10 space-y-3 bg-slate-800/50 p-8 rounded-3xl border-2 border-white/10"></div>
            <div class="flex flex-col gap-4 w-full max-w-xs">
                <button onclick="downloadResults()" class="btn-game bg-amber-500 text-white px-10 py-5 rounded-2xl font-black text-xl shadow-[0_6px_0_rgb(180,83,9)]">üìä RAPORU ƒ∞NDƒ∞R</button>
                <button onclick="location.reload()" class="btn-game bg-green-600 text-white px-10 py-5 rounded-2xl font-black text-xl shadow-[0_6px_0_rgb(22,101,52)]">TEKRAR OYNA</button>
            </div>
        </div>
    </div>

    <script>
        const questionsData = [
            { id: 1, concept: "Hazƒ±rlƒ±k", variants: {
                DY: { q: "El yƒ±kamaya ba≈ülamadan √∂nce ellerimizi suyla ƒ±slatƒ±rƒ±z.", opts: ["DOƒûRU", "YANLI≈û"], ans: "DOƒûRU" },
                BD: { q: "El yƒ±kamaya ba≈ülamadan √∂nce ellerimizi √∂nce _________.", opts: ["Sabunlarƒ±z", "Kurularƒ±z", "Islatƒ±rƒ±z"], ans: "Islatƒ±rƒ±z" },
                CS: { q: "El yƒ±kamaya ba≈ülamadan √∂nce ellerimizi √∂nce ne yaparƒ±z?", opts: ["Sabunlarƒ±z", "Islatƒ±rƒ±z", "Kurularƒ±z"], ans: "Islatƒ±rƒ±z" }
            }},
            { id: 2, concept: "Sƒ±ralama", variants: {
                DY: { q: "Doƒüru Sƒ±ra: Islat ‚Üí Sabunla ‚Üí Parmak Arasƒ± ‚Üí Durula. Bu doƒüru mu?", opts: ["EVET", "HAYIR"], ans: "EVET" },
                BD: { q: "El yƒ±karken √∂nce ellerimizi ________, sonra sabun alƒ±rƒ±z.", opts: ["Islatƒ±rƒ±z", "Kurularƒ±z", "Ovu≈ütururuz"], ans: "Islatƒ±rƒ±z" },
                CS: { q: "A≈üaƒüƒ±dakilerden hangisi doƒüru el yƒ±kama sƒ±rasƒ±nƒ± g√∂sterir?", opts: ["Sabun-Durula-Islat", "Islat-Sabun-Durula", "Durula-Sabun-Islat"], ans: "Islat-Sabun-Durula" }
            }},
            { id: 3, concept: "Mikroplar", variants: {
                DY: { q: "Sabunla yƒ±kadƒ±ƒüƒ±mƒ±zda 'ge√ßici mikroplar' uzakla≈üƒ±r.", opts: ["DOƒûRU", "YANLI≈û"], ans: "DOƒûRU" },
                BD: { q: "Sabunla el yƒ±kadƒ±ƒüƒ±mƒ±zda bizi hasta edebilen __________ mikroplar uzakla≈üƒ±r.", opts: ["Kalƒ±cƒ±", "Ge√ßici", "Yararlƒ±"], ans: "Ge√ßici" },
                CS: { q: "Bizi hastalandƒ±ran ve sabunla uzakla≈üan mikroplar hangileridir?", opts: ["Kalƒ±cƒ±", "Ge√ßici", "Yararlƒ±"], ans: "Ge√ßici" }
            }},
            { id: 4, concept: "S√ºre", variants: {
                DY: { q: "Ellerimizi yƒ±karken 5 saniye ovu≈üturmak yeterlidir.", opts: ["DOƒûRU", "YANLI≈û"], ans: "YANLI≈û" },
                BD: { q: "Ellerimizi yƒ±karken en az _______‚Äôe kadar saymalƒ±yƒ±z.", opts: ["5", "10", "15"], ans: "15" },
                CS: { q: "Ellerimizi yƒ±karken ka√ßa kadar saymalƒ±yƒ±z?", opts: ["5", "10", "15"], ans: "15" }
            }},
            { id: 5, concept: "Ama√ß", variants: {
                DY: { q: "El yƒ±kamanƒ±n temel amacƒ± ellerin g√ºzel kokmasƒ±dƒ±r.", opts: ["DOƒûRU", "YANLI≈û"], ans: "YANLI≈û" },
                BD: { q: "El yƒ±kamanƒ±n temel amacƒ± __________ kurtulmaktƒ±r.", opts: ["Mikroplardan", "Kirden", "K√∂t√º kokudan"], ans: "Mikroplardan" },
                CS: { q: "El yƒ±kamanƒ±n amacƒ± nedir?", opts: ["Temiz g√∂r√ºnmek", "Mikroplardan kurtulmak", "G√ºzel kokmak"], ans: "Mikroplardan kurtulmak" }
            }},
            { id: 6, concept: "Genel", variants: {
                DY: { q: "Ellerimizi sadece kirli g√∂r√ºnce yƒ±kamalƒ±yƒ±z.", opts: ["DOƒûRU", "YANLI≈û"], ans: "YANLI≈û" },
                BD: { q: "Tƒ±rnaklarƒ±n i√ßi kir ve mikropla dolabilir, bu y√ºzden ________.", opts: ["Yƒ±kanmalƒ±dƒ±r", "Kesilmemelidir", "Saklanmalƒ±dƒ±r"], ans: "Yƒ±kanmalƒ±dƒ±r" },
                CS: { q: "Elleri yƒ±karken hangisi temizliƒüi artƒ±rƒ±r?", opts: ["Sadece su", "Hƒ±zlƒ± yƒ±kama", "Parmak aralarƒ±nƒ± s√ºrtmek"], ans: "Parmak aralarƒ±nƒ± s√ºrtmek" }
            }}
        ];

        let state = {
            score: 0,
            pieces: 0,
            activeQueue: [],
            retryQueue: [],
            isProcessing: false,
            waitingForPuzzleClick: false,
            logs: [],
            attempts: {}, // Her soru i√ßin deneme sayƒ±sƒ±nƒ± tutar
            userId: "K-" + Math.floor(1000 + Math.random() * 9000)
        };

        function initPuzzle() {
            const container = document.getElementById('puzzle-view');
            container.querySelectorAll('.puzzle-slot').forEach(s => s.remove());

            for (let i = 0; i < 6; i++) {
                const slot = document.createElement('div');
                slot.className = 'puzzle-slot';
                slot.id = `slot-${i}`;
                slot.onclick = () => handleSlotClick(i);

                const piece = document.createElement('div');
                piece.className = 'puzzle-piece';
                piece.id = `piece-${i}`;
                piece.style.backgroundPosition = `${(i % 3) * 50}% ${Math.floor(i / 3) * 100}%`;
                
                slot.appendChild(piece);
                container.appendChild(slot);
            }
        }

        // G√ºncellenmi≈ü Daƒüƒ±nƒ±k √áamur Efekti
        function triggerMudEffect() {
            const container = document.getElementById('mud-container');
            const splatCount = 35;

            for (let i = 0; i < splatCount; i++) {
                const splat = document.createElement('div');
                splat.className = 'mud-splat';
                const size = Math.random() * 80 + 20;
                const r1 = Math.random() * 50 + 20;
                const r2 = Math.random() * 50 + 20;
                const r3 = Math.random() * 50 + 20;
                const r4 = Math.random() * 50 + 20;
                
                splat.style.width = `${size}px`;
                splat.style.height = `${size * (Math.random() * 0.5 + 0.8)}px`;
                splat.style.borderRadius = `${r1}% ${100-r1}% ${r2}% ${100-r2}% / ${r3}% ${r4}% ${100-r4}% ${100-r3}%`;
                splat.style.left = `${Math.random() * 100}vw`;
                splat.style.top = `${Math.random() * 80}vh`;
                
                const delay = Math.random() * 0.5;
                const duration = Math.random() * 1 + 2;
                splat.style.animationDelay = `${delay}s`;
                splat.style.animationDuration = `${duration}s`;

                container.appendChild(splat);
                setTimeout(() => splat.remove(), (delay + duration) * 1000);
            }
        }

        function startGame() {
            initPuzzle();
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('question-view').classList.remove('hidden');
            
            // Sorularƒ± ve deneme sayƒ±larƒ±nƒ± ilklendir
            state.activeQueue = questionsData.map(q => {
                state.attempts[q.id] = 1;
                return {...q, variantIdx: 0, order: ['DY', 'BD', 'CS']};
            });
            
            nextQuestion();
        }

        function nextQuestion() {
            if (state.pieces >= 6) {
                endGame();
                return;
            }
            if (state.retryQueue.length > 0 && (state.activeQueue.length === 0 || Math.random() > 0.4)) {
                state.current = state.retryQueue.shift();
            } else {
                state.current = state.activeQueue.shift();
            }
            renderQuestion();
        }

        function renderQuestion() {
            const q = state.current;
            const variant = q.variants[q.order[q.variantIdx]];
            document.getElementById('question-category').innerText = q.concept;
            document.getElementById('question-text').innerText = variant.q;
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            const colors = ['bg-blue-600', 'bg-indigo-600', 'bg-violet-600'];
            variant.opts.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = `btn-game ${colors[i % 3]} text-white p-6 rounded-2xl font-bold text-2xl shadow-[0_6px_0_rgba(0,0,0,0.3)]`;
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, variant.ans);
                container.appendChild(btn);
            });
        }

        async function checkAnswer(selected, correct) {
            if (state.isProcessing) return;
            state.isProcessing = true;
            const isCorrect = selected.toUpperCase() === correct.toUpperCase();

            if (isCorrect) {
                // Soru bazlƒ± puan hesaplama (100 - hatalƒ± denemeler * 20)
                const questionScore = 100 - ((state.attempts[state.current.id] - 1) * 20);
                state.score += 100; // Oyun i√ßi skor toplam puan √ºzerinden y√ºr√ºr
                
                // Log kaydƒ±: ƒ∞stenen formatta g√ºncelleme
                state.logs.push({
                    "Kahraman": state.userId,
                    "Soru No": state.current.id,
                    "Deneme Sayƒ±sƒ±": state.attempts[state.current.id],
                    "Sonu√ß": "DOƒûRU",
                    "Puan": questionScore, // Sadece bu sorudan alƒ±nan net puan
                    "Tarih": new Date().toLocaleTimeString()
                });

                showFeedback("TEBRƒ∞KLER!", "üèÜ", "text-yellow-400", "Rozet kazandƒ±n! Rozetini puzzle'ƒ± tamamlamak i√ßin kullan!");
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                
                await new Promise(r => setTimeout(r, 2500));
                hideFeedback();

                const pView = document.getElementById('puzzle-view');
                pView.classList.add('active');
                
                const nextSlot = document.getElementById(`slot-${state.pieces}`);
                if (nextSlot) nextSlot.classList.add('clickable');
                
                state.waitingForPuzzleClick = true;
            } else {
                // Yanlƒ±≈ü cevapta deneme sayƒ±sƒ±nƒ± artƒ±r
                state.attempts[state.current.id]++;
                
                triggerMudEffect();
                showFeedback("Mƒ∞KROP SALDIRISI!", "ü¶†", "text-red-500", "Hata yaptƒ±n! Mikroplar odayƒ± √ßamurla kirletti!");
                document.getElementById('main-card').classList.add('shake');
                state.score = Math.max(0, state.score - 20);
                document.getElementById('score-display').innerText = state.score;

                setTimeout(() => {
                    document.getElementById('main-card').classList.remove('shake');
                    hideFeedback();
                    if (state.current.variantIdx < 2) state.current.variantIdx++;
                    state.retryQueue.push(state.current);
                    nextQuestion();
                    state.isProcessing = false;
                }, 2500);
            }
        }

        async function handleSlotClick(index) {
            if (!state.waitingForPuzzleClick || index !== state.pieces) return;
            
            state.waitingForPuzzleClick = false;
            const slot = document.getElementById(`slot-${index}`);
            slot.classList.remove('clickable');
            
            const piece = document.getElementById(`piece-${index}`);
            piece.classList.add('placed');
            
            state.pieces++;
            
            document.getElementById('score-display').innerText = state.score;
            document.getElementById('progress-bar').style.width = `${(state.pieces/6)*100}%`;
            document.getElementById('badge-display').innerHTML += 'üß©';

            await new Promise(r => setTimeout(r, 1500));
            
            const pView = document.getElementById('puzzle-view');
            pView.classList.remove('active');
            await new Promise(r => setTimeout(r, 400));
            
            state.isProcessing = false;
            nextQuestion();
        }

        function showFeedback(text, icon, colorClass, subText) {
            const overlay = document.getElementById('feedback-overlay');
            const txt = document.getElementById('feedback-text');
            const sub = document.getElementById('feedback-sub');
            const hero = document.querySelector('.hero-img-feedback');
            
            if (text.includes("Mƒ∞KROP")) {
                hero.src = "https://raw.githubusercontent.com/ecemyildizcan/mikrostop/main/asserts/mikrop.png";
                hero.style.borderColor = "#ef4444";
            } else {
                hero.src = "https://raw.githubusercontent.com/ecemyildizcan/mikrostop/main/asserts/kahraman.png";
                hero.style.borderColor = "#3b82f6";
            }

            txt.innerText = text;
            txt.className = `text-5xl font-bold ${colorClass} drop-shadow-lg`;
            sub.innerText = subText;
            overlay.style.display = 'flex';
        }

        function hideFeedback() {
            document.getElementById('feedback-overlay').style.display = 'none';
        }

        function endGame() {
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('question-view').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            const pView = document.getElementById('puzzle-view');
            pView.classList.add('active');
            document.getElementById('puzzle-ghost').style.opacity = '0';
            
            // Puan g√∂sterimi kaldƒ±rƒ±ldƒ±
            document.getElementById('final-stats').innerHTML = `
                <div class="text-center">
                    <p class="text-slate-400 mb-4">Kahraman Kimliƒüi: <span class="text-white">${state.userId}</span></p>
                    <p class="text-white font-bold tracking-widest uppercase">Tebrikler Kahraman! T√ºm puzzle par√ßalarƒ±nƒ± topladƒ±n ve odayƒ± mikroplardan tamamen temizledin!</p>
                </div>
            `;
            confetti({ particleCount: 400, spread: 150, origin: { y: 0.6 } });
        }

        function downloadResults() {
            if (state.logs.length === 0) return;
            const ws = XLSX.utils.json_to_sheet(state.logs);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Puzzle Sonu√ßlarƒ±");
            XLSX.writeFile(wb, `MikropAvcisi_Puzzle_Raporu_${state.userId}.xlsx`);
        }
    </script>
</body>
</html>
